<!DOCTYPE html>
<html lang="pl">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monitor Aukcji Aut ze Szwajcarii</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .header p {
      font-size: 1.1rem;
      opacity: 0.9;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      text-align: center;
      transition: transform 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-5px);
    }

    .stat-number {
      font-size: 2rem;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 5px;
    }

    .stat-label {
      color: #666;
      font-size: 0.9rem;
    }

    .controls {
      text-align: center;
      margin-bottom: 30px;
    }

    .btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.3s ease;
      margin: 0 10px;
    }

    .btn:hover {
      background: #5a6fd8;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .sections {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
    }

    .section {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .section h2 {
      color: #333;
      margin-bottom: 20px;
      font-size: 1.5rem;
      border-bottom: 3px solid #667eea;
      padding-bottom: 10px;
    }

    .auction-list {
      max-height: 500px;
      overflow-y: auto;
    }

    .auction-item {
      border: 1px solid #eee;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      transition: all 0.3s ease;
      background: #fafafa;
    }


    .auction-item.ended {
      opacity: 0.6;
      background: #f5f5f5;
    }

    .auction-title {
      font-weight: bold;
      color: #333;
      margin-bottom: 8px;
      font-size: 1.1rem;
    }

    .auction-title a {
      color: #667eea;
      text-decoration: none;
    }

    .auction-title a:hover {
      text-decoration: underline;
    }

    .auction-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      font-size: 0.9rem;
      color: #666;
    }

    .auction-time {
      font-weight: bold;
      color: #e74c3c;
    }

    .auction-time.ended {
      color: #95a5a6;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }

    .error {
      background: #ffebee;
      color: #c62828;
      padding: 15px;
      border-radius: 10px;
      margin: 10px 0;
    }

    .success {
      background: #e8f5e8;
      color: #2e7d32;
      padding: 15px;
      border-radius: 10px;
      margin: 10px 0;
    }

    @media (max-width: 768px) {
      .sections {
        grid-template-columns: 1fr;
      }

      .header h1 {
        font-size: 2rem;
      }

      .auction-details {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>üöó Monitor Aukcji Aut ze Szwajcarii</h1>
      <p>≈öled≈∫ nowe aukcje i najbli≈ºsze zako≈Ñczenia</p>
    </div>


    <div class="controls" style="display: flex; flex-direction: column; gap: 10px; align-items: center;">
      <button class="btn" onclick="refreshData()" id="refresh-btn">üîÑ Poka≈º nowe aukcje</button>
      <button class="btn" onclick="markAsVisited()" id="mark-visited-btn">‚úÖ Sprawdzi≈Çem wszystko, wyczy≈õƒá</button>
    </div>


    <div class="sections">
      <div class="section">
        <h2>üÜï Nowe aukcje (od ostatniej wizyty)</h2>

        <div class="stats" id="auction-stats" style="margin-bottom: 20px;">
          <div class="stat-card">
            <div class="stat-number" id="auctions-count-before">-</div>
            <div class="stat-label">Ostatnia liczba</div>
            <div class="stat-time" id="before-scraper-date" style="font-size: 0.8rem; color: #888; margin-top: 5px;">-
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="auctions-count-after">-</div>
            <div class="stat-label">Aktualna liczba</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="auctions-count-new">-</div>
            <div class="stat-label">Nowe aukcje</div>
          </div>
        </div>
        <div id="new-auctions" class="auction-list">
          <div class="loading">≈Åadowanie...</div>
        </div>
      </div>

      <div class="section">
        <h2>üîç Obserwowane wyszukiwania</h2>

        <div style="margin-bottom: 20px;">
          <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <input type="text" id="new-search-term" placeholder="Wpisz frazƒô (np. 'audi', 'bmw x3')"
              style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;"
              onkeypress="if(event.key==='Enter') addWatchedSearch()">
            <button class="btn" onclick="addWatchedSearch()" style="padding: 10px 15px;">‚ûï Dodaj</button>
          </div>
        </div>

        <div id="watched-searches" class="auction-list">
          <div class="loading">≈Åadowanie...</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let refreshInProgress = false;
    let lastVisitTimestamp = Date.now() / 1000 - 86400; // domy≈õlnie 24h temu
    let lastScraperDate = null;


    async function loadNewAuctions() {
      try {
        const response = await fetch(`/api/new_auctions?since=${lastVisitTimestamp}`);
        const auctions = await response.json();

        const container = document.getElementById('new-auctions');

        if (auctions.length === 0) {
          container.innerHTML = '<div class="loading">Brak nowych aukcji od ostatniej wizyty</div>';
          return;
        }

        container.innerHTML = auctions.map(auction => `
                    <div class="auction-item ${auction.is_ended ? 'ended' : ''}">
                        <div class="auction-title">
                            <a href="${auction.href}" target="_blank">${auction.title}</a>
                        </div>
                        <div class="auction-details">
                            <div>ID: ${auction.id}</div>
                            <div>Dodano: ${auction.first_seen}</div>
                            <div>Koniec: ${auction.end_time}</div>
                            <div class="auction-time ${auction.is_ended ? 'ended' : ''}">
                                ${auction.time_until_end}
                            </div>
                        </div>
                    </div>
                `).join('');
      } catch (error) {
        document.getElementById('new-auctions').innerHTML =
          '<div class="error">B≈ÇƒÖd ≈Çadowania nowych aukcji</div>';
        console.error('B≈ÇƒÖd ≈Çadowania nowych aukcji:', error);
      }
    }

    async function loadWatchedSearches() {
      try {
        console.log('≈Åadowanie obserwowanych wyszukiwa≈Ñ...');
        const response = await fetch('/api/watched_searches');
        const searches = await response.json();
        console.log('Otrzymane wyszukiwania:', searches);

        const container = document.getElementById('watched-searches');

        if (searches.length === 0) {
          container.innerHTML = '<div class="loading">Brak obserwowanych wyszukiwa≈Ñ. Dodaj frazƒô powy≈ºej.</div>';
          return;
        }

        const html = searches.map(search => `
                    <div class="auction-item" style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div class="auction-title" style="margin-bottom: 0;">
                                üîç "${search.search_term}"
                            </div>
                            <div style="display: flex; gap: 5px;">
                                <button class="btn" onclick="markSearchChecked(${search.id})" 
                                        style="padding: 5px 10px; font-size: 12px;">‚úÖ Sprawdzone</button>
                                <button class="btn" onclick="removeWatchedSearch(${search.id})" 
                                        style="padding: 5px 10px; font-size: 12px; background: #e74c3c;">‚ùå Usu≈Ñ</button>
                            </div>
                        </div>
                        <div style="font-size: 0.8rem; color: #666; margin-bottom: 10px;">
                            Dodano: ${search.created} | Ostatnie sprawdzenie: ${search.last_check}
                        </div>
                        ${search.new_auctions.length > 0 ? `
                            <div style="margin-top: 10px;">
                                <strong>Nowe aukcje (${search.new_auctions.length}):</strong>
                                ${search.new_auctions.map(auction => `
                                    <div style="border-left: 3px solid #667eea; padding-left: 10px; margin: 8px 0; background: #f8f9fa; padding: 8px; border-radius: 5px;">
                                        <div style="font-weight: bold;">
                                            <a href="${auction.href}" target="_blank" style="color: #667eea;">${auction.title}</a>
                                        </div>
                                        <div style="font-size: 0.8rem; color: #666; margin-top: 4px;">
                                            ID: ${auction.id} | Koniec: ${auction.end_time} | ${auction.time_until_end}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<div style="color: #666; font-style: italic;">Brak nowych aukcji</div>'}
                    </div>
                `).join('');

        console.log('Generowanie HTML:', html);
        container.innerHTML = html;
        console.log('HTML wstawiony do kontenera');

      } catch (error) {
        console.error('B≈ÇƒÖd ≈Çadowania obserwowanych wyszukiwa≈Ñ:', error);
        document.getElementById('watched-searches').innerHTML =
          '<div class="error">B≈ÇƒÖd ≈Çadowania obserwowanych wyszukiwa≈Ñ</div>';
      }
    }

    async function refreshData() {
      if (refreshInProgress) return;

      refreshInProgress = true;
      const btn = document.getElementById('refresh-btn');
      btn.disabled = true;
      btn.textContent = '‚è≥ Pobieranie...';

      // Pobierz liczbƒô aukcji przed scraperem
      try {
        const beforeResponse = await fetch('/api/stats');
        const beforeStats = await beforeResponse.json();
        const now = new Date();
        const timeString = now.toLocaleString('pl-PL');

        document.getElementById('auctions-count-before').textContent = beforeStats.total_auctions;
        document.getElementById('before-scraper-date').textContent = timeString;

        // Zapisz datƒô w bazie danych
        lastScraperDate = timeString;
        await saveSetting('lastScraperDate', timeString);
      } catch (error) {
        console.error('B≈ÇƒÖd pobierania statystyk przed:', error);
      }

      try {
        const response = await fetch('/refresh');
        const result = await response.json();

        if (result.success) {
          // Pobierz liczbƒô aukcji po scraperze
          try {
            const afterResponse = await fetch('/api/stats');
            const afterStats = await afterResponse.json();
            const beforeCount = parseInt(document.getElementById('auctions-count-before').textContent);
            const afterCount = afterStats.total_auctions;
            const newCount = afterCount - beforeCount;

            document.getElementById('auctions-count-after').textContent = afterCount;
            document.getElementById('auctions-count-new').textContent = newCount;
          } catch (error) {
            console.error('B≈ÇƒÖd pobierania statystyk po:', error);
          }

          // Od≈õwie≈º wszystkie dane po zako≈Ñczeniu scrapera
          await Promise.all([
            loadNewAuctions(),
            loadWatchedSearches()
          ]);

          // Poka≈º komunikat o sukcesie
          const container = document.querySelector('.container');
          const successDiv = document.createElement('div');
          successDiv.className = 'success';
          successDiv.textContent = '‚úÖ Dane zosta≈Çy od≈õwie≈ºone pomy≈õlnie!';
          container.insertBefore(successDiv, container.firstChild);

          // Usu≈Ñ komunikat po 3 sekundach
          setTimeout(() => {
            successDiv.remove();
          }, 3000);
        } else {
          throw new Error(result.error || 'Nieznany b≈ÇƒÖd');
        }
      } catch (error) {
        const container = document.querySelector('.container');
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error';
        errorDiv.textContent = `‚ùå B≈ÇƒÖd od≈õwie≈ºania: ${error.message}`;
        container.insertBefore(errorDiv, container.firstChild);

        setTimeout(() => {
          errorDiv.remove();
        }, 5000);
      } finally {
        refreshInProgress = false;
        btn.disabled = false;
        btn.textContent = 'üîÑ Poka≈º nowe aukcje';
      }
    }

    async function loadData() {
      // Za≈Çaduj ustawienia z bazy danych
      await loadSettings();

      // Pobierz liczbƒô aukcji przy starcie
      try {
        const response = await fetch('/api/stats');
        const stats = await response.json();

        document.getElementById('auctions-count-before').textContent = stats.total_auctions;
        document.getElementById('auctions-count-after').textContent = stats.total_auctions;
        document.getElementById('auctions-count-new').textContent = '0';

        // Poka≈º zapisanƒÖ datƒô lub aktualnƒÖ datƒô
        if (lastScraperDate) {
          document.getElementById('before-scraper-date').textContent = lastScraperDate;
        } else {
          const now = new Date();
          const timeString = now.toLocaleString('pl-PL');
          document.getElementById('before-scraper-date').textContent = timeString;
        }
      } catch (error) {
        console.error('B≈ÇƒÖd pobierania statystyk:', error);
      }

      await Promise.all([
        loadNewAuctions(),
        loadWatchedSearches()
      ]);
    }

    async function addWatchedSearch() {
      const input = document.getElementById('new-search-term');
      const searchTerm = input.value.trim();

      if (!searchTerm) {
        alert('Wpisz frazƒô do obserwowania');
        return;
      }

      try {
        const response = await fetch('/api/add_watched_search', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ search_term: searchTerm })
        });

        const result = await response.json();

        if (result.success) {
          input.value = '';
          await loadWatchedSearches();

          // Poka≈º komunikat o sukcesie
          const container = document.querySelector('.container');
          const successDiv = document.createElement('div');
          successDiv.className = 'success';
          successDiv.textContent = result.message;
          container.insertBefore(successDiv, container.firstChild);

          setTimeout(() => {
            successDiv.remove();
          }, 3000);
        } else {
          alert('B≈ÇƒÖd: ' + result.error);
        }
      } catch (error) {
        console.error('B≈ÇƒÖd dodawania obserwowanego wyszukiwania:', error);
        alert('B≈ÇƒÖd dodawania obserwowanego wyszukiwania');
      }
    }

    async function removeWatchedSearch(searchId) {
      if (!confirm('Czy na pewno chcesz usunƒÖƒá to obserwowane wyszukiwanie?')) {
        return;
      }

      try {
        const response = await fetch(`/api/remove_watched_search/${searchId}`, {
          method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
          await loadWatchedSearches();
        } else {
          alert('B≈ÇƒÖd: ' + result.error);
        }
      } catch (error) {
        console.error('B≈ÇƒÖd usuwania obserwowanego wyszukiwania:', error);
        alert('B≈ÇƒÖd usuwania obserwowanego wyszukiwania');
      }
    }

    async function markSearchChecked(searchId) {
      try {
        const response = await fetch(`/api/mark_search_checked/${searchId}`, {
          method: 'POST'
        });

        const result = await response.json();

        if (result.success) {
          await loadWatchedSearches();
        } else {
          alert('B≈ÇƒÖd: ' + result.error);
        }
      } catch (error) {
        console.error('B≈ÇƒÖd oznaczania jako sprawdzone:', error);
        alert('B≈ÇƒÖd oznaczania jako sprawdzone');
      }
    }

    async function markAsVisited() {
      try {
        const response = await fetch('/api/mark_visited');
        const result = await response.json();

        if (result.success) {
          lastVisitTimestamp = result.timestamp;
          await saveSetting('lastVisitTimestamp', lastVisitTimestamp.toString());

          // Wyczy≈õƒá listƒô nowych aukcji
          document.getElementById('new-auctions').innerHTML =
            '<div class="loading">Brak nowych aukcji od ostatniej wizyty</div>';

          // Poka≈º komunikat o sukcesie
          const container = document.querySelector('.container');
          const successDiv = document.createElement('div');
          successDiv.className = 'success';
          successDiv.textContent = '‚úÖ Wszystko sprawdzone, lista wyczyszczona!';
          container.insertBefore(successDiv, container.firstChild);

          setTimeout(() => {
            successDiv.remove();
          }, 3000);
        }
      } catch (error) {
        console.error('B≈ÇƒÖd oznaczania wizyty:', error);
      }
    }



    // Za≈Çaduj dane przy starcie
    document.addEventListener('DOMContentLoaded', () => {
      loadData();
    });

    // Automatyczne od≈õwie≈ºanie co 5 minut
    setInterval(loadData, 300000);

    // Funkcje do pracy z ustawieniami w bazie danych
    async function loadSettings() {
      try {
        // Za≈Çaduj lastVisitTimestamp
        const timestampResponse = await fetch('/api/get_setting/lastVisitTimestamp');
        const timestampResult = await timestampResponse.json();
        if (timestampResult.success && timestampResult.value) {
          lastVisitTimestamp = parseFloat(timestampResult.value);
        }

        // Za≈Çaduj lastScraperDate
        const dateResponse = await fetch('/api/get_setting/lastScraperDate');
        const dateResult = await dateResponse.json();
        if (dateResult.success && dateResult.value) {
          lastScraperDate = dateResult.value;
        }
      } catch (error) {
        console.error('B≈ÇƒÖd ≈Çadowania ustawie≈Ñ:', error);
      }
    }

    async function saveSetting(key, value) {
      try {
        const response = await fetch(`/api/set_setting/${key}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ value: value })
        });
        const result = await response.json();
        return result.success;
      } catch (error) {
        console.error('B≈ÇƒÖd zapisywania ustawienia:', error);
        return false;
      }
    }
  </script>
</body>

</html>